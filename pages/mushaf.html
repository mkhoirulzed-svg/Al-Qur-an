<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Mushaf</title>

<link rel="stylesheet" href="../style.css">

<style>
/* =========================
   MUSHAF STYLE
========================= */
body {
  background: #fdfcf8;
}

.mushaf-container {
  max-width: 720px;
  margin: auto;
  padding: 20px 16px 80px;
  font-family: 'Amiri', serif;
}

.surah-header {
  text-align: center;
  margin: 50px 0 24px;
  font-size: 1.6rem;
  opacity: 0.8;
}

.bismillah {
  text-align: center;
  font-size: 2.6rem;
  margin: 28px 0 20px;
  letter-spacing: 1px;
}

.mushaf-arab {
  direction: rtl;
  text-align: justify;
  font-size: 2.2rem;
  line-height: 2.2;
  word-spacing: 2px;
}

.ayat-no {
  font-size: 1.3rem;
  margin: 0 4px;
}
   /* nomor ayat */
.ayat-no {
  cursor: pointer;
  user-select: none;
  transition: color 0.2s ease;
}

/* ayat dibookmark */
.ayat-no.bookmarked {
  color: #1e40af;
  font-weight: 600;
}

</style>
</head>

<body>

<header class="app-header">
  <button class="nav-btn back-btn" onclick="history.back()">
    <svg viewBox="0 0 24 24" width="22" height="22"
      fill="none"
      stroke="currentColor"
      stroke-width="2.5"
      stroke-linecap="round"
      stroke-linejoin="round">
      <polyline points="15 18 9 12 15 6"></polyline>
    </svg>
  </button>

  <div class="header-title">
    <div id="judul-juz">Juz</div>
    <div id="judul-surah" class="judul-surah"></div>
  </div>
</header>

<main class="mushaf-container" id="mushafContent">
  <p>Memuat mushaf...</p>
</main>

<script src="../data/juz-map.js"></script>
<script>
const mushafContent = document.getElementById('mushafContent');
const judulJuz = document.getElementById('judul-juz');

const juzParam = new URLSearchParams(location.search).get('no');
const juzNo = Number(juzParam);
const judulSurah = document.getElementById('judul-surah');


if (!juzParam || isNaN(juzNo) || juzNo < 1 || juzNo > 30) {
  mushafContent.innerHTML = '<p>Juz tidak ditemukan.</p>';
  throw new Error('Invalid Juz');
}

judulJuz.textContent = `Juz ${juzNo}`;

const juzInfo = JUZ_MAP.find(j => j.juz === juzNo);
if (!juzInfo) {
  mushafContent.innerHTML = '<p>Juz tidak valid</p>';
  throw new Error('Invalid Juz');
}

function toArabicNumber(num) {
  const d = ['٠','١','٢','٣','٤','٥','٦','٧','٨','٩'];
  return String(num).replace(/\d/g, x => d[x]);
}

  function isBookmarked(juz, surah, ayat) {
  return getBookmarks().some(b =>
    b.mode === 'juz' &&
    b.juz == juz &&
    b.surah == surah &&
    b.ayat == ayat
  );
}
 
   
async function loadMushaf({ start, end }) {
  mushafContent.innerHTML = '';

  for (let surah = start[0]; surah <= end[0]; surah++) {
    const res = await fetch(
      `https://api.alquran.cloud/v1/surah/${surah}/editions/ar.alafasy`
    );
    const json = await res.json();
    const arab = json.data[0];

    // HEADER SURAH
   const header = document.createElement('div');
header.className = 'surah-header';
header.textContent = `${arab.englishName} (${arab.name})`;
mushafContent.appendChild(header);

// set judul surah di header atas (sekali saja)
if (!judulSurah.textContent) {
  judulSurah.textContent = `${arab.englishName} (${arab.name})`;
}


    // KUMPULKAN AYAT DALAM 1 BLOK
    let ayatText = '';

    arab.ayahs.forEach(a => {
      const ayatNo = a.numberInSurah;

      if (
        (surah === start[0] && ayatNo < start[1]) ||
        (surah === end[0] && ayatNo > end[1])
      ) return;

      let text = a.text;

      // BISMAILLAH MANUAL (AWAL SURAH)
      if (
        ayatNo === 1 &&
        arab.number !== 1 &&
        arab.number !== 9
      ) {
        const bismillah = document.createElement('div');
        bismillah.className = 'bismillah';
        bismillah.textContent = 'بِسْمِ اللَّهِ الرَّحْمَٰنِ الرَّحِيمِ';
        mushafContent.appendChild(bismillah);

        text = text.replace(
          /^بِسْمِ\s*ٱ?للَّهِ\s*ٱ?لرَّحْمَٰنِ\s*ٱ?لرَّحِيمِ\s*/u,
          ''
        ).trim();
      }
       
const bookmarked = isBookmarked(juzNo, surah, ayatNo)
    ? 'bookmarked'
    : '';
       
     ayatText += `
  ${text}
  <span
    class="ayat-no"
    data-juz="${juzNo}"
    data-surah="${surah}"
    data-ayat="${ayatNo}"
  >﴿${toArabicNumber(ayatNo)}﴾</span>
`;
    });

    const block = document.createElement('div');
    block.className = 'mushaf-arab';
    block.innerHTML = ayatText;
    mushafContent.appendChild(block);
  }
}

loadMushaf(juzInfo);

   /* =========================
   BOOKMARK (LONG PRESS)
========================= */
function getBookmarks() {
  return JSON.parse(localStorage.getItem('bookmarks')) || [];
}

function saveBookmarks(data) {
  localStorage.setItem('bookmarks', JSON.stringify(data));
}

let pressTimer = null;
let pressedEl = null;

document.addEventListener('touchstart', e => {
  const target = e.target.closest('.ayat-no');
  if (!target) return;

  pressedEl = target;

  pressTimer = setTimeout(() => {
    toggleBookmark(target);
  }, 600);
});

document.addEventListener('touchend', clearPress);
document.addEventListener('touchmove', clearPress);
document.addEventListener('touchcancel', clearPress);

function clearPress() {
  if (pressTimer) {
    clearTimeout(pressTimer);
    pressTimer = null;
  }
}

function toggleBookmark(el) {
  const juz   = el.dataset.juz;
  const surah = el.dataset.surah;
  const ayat  = el.dataset.ayat;

  let bookmarks = getBookmarks();

  const idx = bookmarks.findIndex(b =>
    b.mode === 'juz' &&
    b.juz == juz &&
    b.surah == surah &&
    b.ayat == ayat
  );

  if (idx >= 0) {
    bookmarks.splice(idx, 1);
    el.classList.remove('bookmarked');
  } else {
    bookmarks.push({
  mode: 'juz',
  juz,
  surah,
  ayat,
  text: el.parentElement.textContent.trim()
});
    el.classList.add('bookmarked');
  }

  saveBookmarks(bookmarks);
}

</script>

</body>
</html>

