<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Juz</title>

<link rel="stylesheet" href="../style.css">
</head>

<body>

<header class="app-header">
  <button class="nav-btn back-btn" onclick="history.back()">‚Üê</button>
  <div class="header-title">
    <span id="judul">Juz</span>
  </div>
  <button class="nav-btn translate-btn" id="toggleTerjemah">üåê</button>
</header>

<main class="container" id="juzContent">
  <p>Memuat juz...</p>
</main>

<script src="../data/juz-map.js"></script>
<script>
const juzNo = Number(new URLSearchParams(location.search).get('no'));
const juzContent = document.getElementById('juzContent');
const judul = document.getElementById('judul');
const toggleBtn = document.getElementById('toggleTerjemah');

judul.textContent = `Juz ${juzNo}`;

const juzInfo = JUZ_MAP.find(j => j.juz === juzNo);
if (!juzInfo) {
  juzContent.innerHTML = '<p>Juz tidak valid</p>';
  throw new Error('Juz tidak valid');
}

/* =========================
   AUDIO CONTROLLER (GLOBAL)
========================= */
const audioPlayer = new Audio();
let ayatQueue = [];
let currentIndex = -1;

/* =========================
   TAJWID COLOR
========================= */
function tajwidColor(text) {
  return text
    .replace(/([ÿßŸàŸä])/g, '<span class="tajwid-mad">$1</span>')
    .replace(/([ŸÜŸÖ]Ÿí)/g, '<span class="tajwid-idgham">$1</span>')
    .replace(/([ŸÇÿ∑ÿ®ÿ¨ÿØ])/g, '<span class="tajwid-qalqalah">$1</span>');
}

/* =========================
   LOAD JUZ
========================= */
async function loadJuz({ start, end }) {
  juzContent.innerHTML = '';
  ayatQueue = [];

  for (let surah = start[0]; surah <= end[0]; surah++) {
    try {
      const res = await fetch(`https://api.alquran.cloud/v1/surah/${surah}/editions/ar.alafasy,id.indonesian`);
      const json = await res.json();

      const arab = json.data[0];
      const indo = json.data[1];

      /* HEADER SURAH */
      const header = document.createElement('div');
      header.className = 'surah-header';
      header.innerHTML = `
        <h3>${arab.englishName}</h3>
        <small>${arab.englishNameTranslation}</small>
      `;
      juzContent.appendChild(header);

      /* BISMILLAH */
      if (arab.number !== 1 && arab.number !== 9) {
        const bismillah = document.createElement('div');
        bismillah.className = 'bismillah ayat-arab';
        bismillah.textContent = 'ÿ®Ÿêÿ≥ŸíŸÖŸê ÿßŸÑŸÑŸëŸéŸáŸê ÿßŸÑÿ±ŸëŸéÿ≠ŸíŸÖŸéŸ∞ŸÜŸê ÿßŸÑÿ±ŸëŸéÿ≠ŸêŸäŸÖŸê';
        juzContent.appendChild(bismillah);
      }

      arab.ayahs.forEach(a => {
        const ayatNo = a.numberInSurah;

        const isStart = surah === start[0] && ayatNo < start[1];
        const isEnd   = surah === end[0]   && ayatNo > end[1];
        if (isStart || isEnd) return;

        const terjemah = indo.ayahs.find(x => x.numberInSurah === ayatNo);

        const div = document.createElement('div');
        div.className = 'ayat-item';

        div.dataset.audio = a.audio;
        div.dataset.index = ayatQueue.length;

        div.innerHTML = `
          <div class="ayat-content">
            <span class="ayat-nomor">${arab.englishName} : ${ayatNo}</span>
            <div class="ayat-arab">${tajwidColor(a.text)}</div>
            <div class="ayat-indo">${terjemah?.text || ''}</div>
          </div>
          <div class="ayat-actions">
            <button class="audio-btn">üîä</button>
            <button class="bookmark-btn">üîñ</button>
          </div>
        `;

        ayatQueue.push(div);
        juzContent.appendChild(div);
      });

    } catch (e) {
      console.error(e);
      juzContent.innerHTML = '<p>Gagal memuat juz</p>';
    }
  }
}

/* =========================
   AUDIO PLAY SEQUENTIAL
========================= */
function playAyat(index) {
  const ayatEl = ayatQueue[index];
  if (!ayatEl) return;

  document.querySelectorAll('.ayat-item')
    .forEach(el => el.classList.remove('ayat-playing'));

  ayatEl.classList.add('ayat-playing');
  ayatEl.scrollIntoView({ behavior: 'smooth', block: 'center' });

  audioPlayer.src = ayatEl.dataset.audio;
  audioPlayer.play();

  currentIndex = index;
}

audioPlayer.addEventListener('ended', () => {
  const next = currentIndex + 1;
  if (next < ayatQueue.length) {
    playAyat(next);
  } else {
    currentIndex = -1;
  }
});

/* =========================
   CLICK HANDLER
========================= */
document.addEventListener('click', e => {

  /* AUDIO */
  if (e.target.classList.contains('audio-btn')) {
    const ayatEl = e.target.closest('.ayat-item');
    const index = Number(ayatEl.dataset.index);

    if (currentIndex === index && !audioPlayer.paused) {
      audioPlayer.pause();
      ayatEl.classList.remove('ayat-playing');
      return;
    }

    playAyat(index);
  }

  /* BOOKMARK */
  if (e.target.classList.contains('bookmark-btn')) {
    const ayatEl = e.target.closest('.ayat-item');

    const bookmark = {
      mode: 'juz',
      juz: juzNo,
      text: ayatEl.querySelector('.ayat-arab').innerText
    };

    const bookmarks = JSON.parse(localStorage.getItem('bookmarks')) || [];
    bookmarks.push(bookmark);
    localStorage.setItem('bookmarks', JSON.stringify(bookmarks));

    e.target.classList.add('active');
  }
});

/* =========================
   TOGGLE TERJEMAH
========================= */
let showTerjemah = true;
toggleBtn.addEventListener('click', () => {
  showTerjemah = !showTerjemah;
  document.body.classList.toggle('hide-translation', !showTerjemah);
  toggleBtn.classList.toggle('active', showTerjemah);
});

/* =========================
   INIT
========================= */
loadJuz(juzInfo);
</script>

</body>
</html>
