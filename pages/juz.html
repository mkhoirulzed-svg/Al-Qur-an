<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Juz</title>

<link rel="stylesheet" href="../style.css">
</head>

<body class="page-juz">

<header class="app-header">
  <button class="nav-btn back-btn" onclick="history.back()"> <svg viewBox="0 0 24 24" width="22" height="22"
      fill="none"
      stroke="currentColor"
      stroke-width="2.5"
      stroke-linecap="round"
      stroke-linejoin="round">
      <polyline points="15 18 9 12 15 6"></polyline>
    </svg></button>

 <div class="header-title">
  <div id="judul-juz">Juz</div>
  <div id="judul-surah" class="judul-surah"></div>
</div>

  <button class="nav-btn translate-btn" id="toggleTerjemah">ğŸŒ</button>
</header>

<main class="container" id="juzContent">
  <p>Memuat juz...</p>
</main>

<audio id="audioPlayer"></audio>

<script src="../data/juz-map.js"></script>
<script>
const judulJuz = document.getElementById('judul-juz');
const judulSurah = document.getElementById('judul-surah');

const juzContent = document.getElementById('juzContent');
const judul = document.getElementById('judul');
const audioPlayer = document.getElementById('audioPlayer');
const toggleBtn = document.getElementById('toggleTerjemah');

const juzParam = new URLSearchParams(location.search).get('no');
const juzNo = Number(juzParam);

// VALIDASI JUZ
if (!juzParam || isNaN(juzNo) || juzNo < 1 || juzNo > 30) {
  judul.textContent = 'Juz tidak valid';
  juzContent.innerHTML = '<p>Juz tidak ditemukan.</p>';
  throw new Error('Invalid Juz Number');
}

// SET JUDUL SETELAH VALID
judulJuz.textContent = `Juz ${juzNo}`;

const juzInfo = JUZ_MAP.find(j => j.juz === juzNo);
if (!juzInfo) {
  juzContent.innerHTML = '<p>Juz tidak valid</p>';
  throw new Error('Juz tidak valid');
}

/* =========================
   BOOKMARK
========================= */
function getBookmarks() {
  return JSON.parse(localStorage.getItem('bookmarks')) || [];
}

function isBookmarked(juz, surah, ayat) {
  return getBookmarks().some(b =>
    b.mode === 'juz' &&
    b.juz == juz &&
    b.surah == surah &&
    b.ayat == ayat
  );
}

/* =========================
   TAJWID
========================= */
function tajwidColor(text) {
  return text
    .replace(/([Ø§ÙˆÙŠ])/g, '<span class="tajwid-mad">$1</span>')
    .replace(/([Ù†Ù…]Ù’)/g, '<span class="tajwid-idgham">$1</span>')
    .replace(/([Ù‚Ø·Ø¨Ø¬Ø¯])/g, '<span class="tajwid-qalqalah">$1</span>');
}

/* =========================
   AUDIO
========================= */
let currentPlaying = null;
let isPlaying = false;

/* =========================
   PLAY / PAUSE BUTTON
========================= */
document.addEventListener('click', e => {
  const btn = e.target.closest('.audio-btn');
  if (!btn) return;

  e.stopPropagation();

  const ayatEl = btn.closest('.ayat-item');
  const audioUrl = ayatEl.dataset.audio;

  if (!audioUrl) return alert('Audio tidak tersedia');

  if (currentPlaying === ayatEl && !audioPlayer.paused) {
    audioPlayer.pause();
    btn.textContent = 'â–¶';
    ayatEl.classList.remove('ayat-playing', 'active');
    currentPlaying = null;
    isPlaying = false;
    return;
  }

  if (currentPlaying && currentPlaying !== ayatEl) {
    const oldBtn = currentPlaying.querySelector('.audio-btn');
    if (oldBtn) oldBtn.textContent = 'â–¶';
    currentPlaying.classList.remove('ayat-playing', 'active');
  }

  currentPlaying = ayatEl;
  isPlaying = true;

  ayatEl.classList.add('ayat-playing', 'active');
  btn.textContent = 'â¸';

  audioPlayer.src = audioUrl;
  audioPlayer.play();
});

/* =========================
   AUTOPLAY NEXT AYAT
========================= */
audioPlayer.addEventListener('ended', () => {
  if (!currentPlaying) return;

  let nextAyat = currentPlaying.nextElementSibling;
  while (nextAyat && !nextAyat.classList.contains('ayat-item')) {
    nextAyat = nextAyat.nextElementSibling;
  }

  if (nextAyat) {
    nextAyat.querySelector('.audio-btn')?.click();
    nextAyat.scrollIntoView({ behavior: 'smooth', block: 'center' });
  } else {
    currentPlaying.classList.remove('ayat-playing', 'active');
    currentPlaying = null;
    isPlaying = false;
  }
});

/* =========================
   OBSERVER JUDUL SURAH
========================= */
const observer = new IntersectionObserver(entries => {
  entries.forEach(entry => {
    if (entry.isIntersecting) {
      judulSurah.textContent = entry.target.dataset.surahName;
    }
  });
}, {
  rootMargin: '-45% 0px -45% 0px',
  threshold: 0
});

/* =========================
   LOAD JUZ
========================= */
async function loadJuz({ start, end }) {
  juzContent.innerHTML = '';
  ayatQueue = [];
  currentIndex = -1;

  let firstSurahSet = false;

  for (let surah = start[0]; surah <= end[0]; surah++) {
    const res = await fetch(
      `https://api.alquran.cloud/v1/surah/${surah}/editions/ar.alafasy,id.indonesian`
    );
    const json = await res.json();

    const arab = json.data[0];
    const indo = json.data[1];

    /* HEADER SURAH */
    const header = document.createElement('div');
    header.className = 'surah-header';
  header.dataset.surahName = `${arab.englishName} (${arab.name})`;
    header.innerHTML = `
      <h3>${arab.englishName}</h3>
      <small>${arab.englishNameTranslation}</small>
    `;

    juzContent.appendChild(header);
    observer.observe(header); // âœ… INI KUNCI UTAMA

    // set judul awal
    if (!firstSurahSet) {
      judulSurah.textContent = header.dataset.surahName;
      firstSurahSet = true;
    }

    arab.ayahs.forEach(a => {
      const ayatNo = a.numberInSurah;

      if (
        (surah === start[0] && ayatNo < start[1]) ||
        (surah === end[0] && ayatNo > end[1])
      ) return;

      let arabText = a.text;
      let bismillahHTML = '';

      if (ayatNo === 1 && arab.number !== 1 && arab.number !== 9) {
        const regex =
          /^Ø¨ÙØ³Ù’Ù…Ù\s*[Ù±Ø§]Ù„Ù„Ù‘ÙÙ‡Ù\s*[Ù±Ø§]Ù„Ø±Ù‘ÙØ­Ù’Ù…ÙÙ°Ù†Ù\s*[Ù±Ø§]Ù„Ø±Ù‘ÙØ­ÙÙŠÙ…Ù\s*/u;

        if (regex.test(arabText)) {
          const match = arabText.match(regex)[0];
          arabText = arabText.replace(regex, '').trim();
          bismillahHTML = `<div class="bismillah ayat-arab">${match}</div>`;
        }
      }

      const terjemah = indo.ayahs.find(x => x.numberInSurah === ayatNo);

      const div = document.createElement('div');
      div.className = 'ayat-item';
      if (isBookmarked(juzNo, surah, ayatNo)) div.classList.add('bookmarked');

      div.dataset.juz = juzNo;
      div.dataset.surah = surah;
      div.dataset.ayat = ayatNo;
      div.dataset.audio = a.audio;

      div.innerHTML = `
  ${bismillahHTML}
  <div class="ayat-content">

    <div class="ayat-arab">
      ${tajwidColor(arabText)}
      <span class="ayat-nomor-inline">ï´¿${toArabicNumber(ayatNo)}ï´¾</span>
    </div>

    <div class="ayat-indo">
      ${terjemah?.text || ''}
    </div>

    <div class="ayat-actions bottom">
      <button class="audio-btn">â–¶</button>
      <img src="../icons/bookmark.png" class="bookmark-btn">
    </div>

  </div>
`;

  }
}

loadJuz(juzInfo);

/* =========================
   TOGGLE TERJEMAH
========================= */
let showTerjemah = true;
toggleBtn.addEventListener('click', () => {
  showTerjemah = !showTerjemah;
  document.body.classList.toggle('hide-translation', !showTerjemah);
  toggleBtn.classList.toggle('active', showTerjemah);
});

/* =========================
   CLICK HANDLER
========================= */
document.addEventListener('click', e => {
  const bookmarkBtn = e.target.closest('.bookmark-btn');
  if (!bookmarkBtn) return;

  const ayatEl = bookmarkBtn.closest('.ayat-item');
  const surah = ayatEl.dataset.surah;
  const ayat  = ayatEl.dataset.ayat;

  let bookmarks = getBookmarks();
  const idx = bookmarks.findIndex(b =>
    b.mode === 'juz' &&
    b.juz == juzNo &&
    b.surah == surah &&
    b.ayat == ayat
  );

  if (idx >= 0) {
    bookmarks.splice(idx, 1);
    ayatEl.classList.remove('bookmarked');
  } else {
    bookmarks.push({
      mode: 'juz',
      juz: juzNo,
      surah,
      ayat,
      text: ayatEl.querySelector('.ayat-arab').innerText
    });
    ayatEl.classList.add('bookmarked');
  }

  localStorage.setItem('bookmarks', JSON.stringify(bookmarks));
});

document.addEventListener('click', e => {
  const ayat = e.target.closest('.ayat-item');

  if (!ayat) {
    document.querySelectorAll('.ayat-item.active')
      .forEach(a => a.classList.remove('active'));
    return;
  }

  if (e.target.closest('.ayat-actions')) return;

  document.querySelectorAll('.ayat-item.active')
    .forEach(a => a.classList.remove('active'));

  ayat.classList.add('active');
});
</script>

</body>
</html>
