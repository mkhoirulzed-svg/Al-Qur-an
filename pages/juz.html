<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Juz</title>

<link rel="stylesheet" href="../style.css">
</head>

<body>

<!-- =========================
     HEADER MODERN
========================= -->
<header class="app-header">
  <button class="nav-btn" onclick="history.back()">â†</button>

  <span id="judul" class="header-title">Juz</span>

  <button id="toggleTerjemah" class="nav-btn translate-btn">ğŸŒ</button>
</header>

<main class="container" id="juzContent">
  <p>Memuat juz...</p>
</main>

<script src="../data/juz-map.js"></script>
<script>
const juzNo = Number(new URLSearchParams(location.search).get('no'));
const juzContent = document.getElementById('juzContent');
const judul = document.getElementById('judul');
const toggleBtn = document.getElementById('toggleTerjemah');

judul.textContent = `Juz ${juzNo}`;

let showTranslation = true;

/* =========================
   TOGGLE TERJEMAH
========================= */
toggleBtn.onclick = () => {
  showTranslation = !showTranslation;
  document.body.classList.toggle('hide-translation', !showTranslation);
  toggleBtn.classList.toggle('active', showTranslation);
};

/* =========================
   LOAD JUZ
========================= */
const juzInfo = JUZ_MAP.find(j => j.juz === juzNo);

if (!juzInfo) {
  juzContent.innerHTML = '<p>Juz tidak valid</p>';
} else {
  loadJuz(juzInfo);
}

/* =========================
   TAJWID COLOR
========================= */
function tajwidColor(text) {
  return text
    .replace(/([Ø§ÙˆÙŠ])/g, '<span class="tajwid-mad">$1</span>')
    .replace(/([Ù†Ù…]Ù’)/g, '<span class="tajwid-idgham">$1</span>')
    .replace(/([Ù‚Ø·Ø¨Ø¬Ø¯])/g, '<span class="tajwid-qalqalah">$1</span>');
}

async function loadJuz({ start, end }) {
  juzContent.innerHTML = '';

  for (let surah = start[0]; surah <= end[0]; surah++) {
    try {
      const res = await fetch(`https://equran.id/api/v2/surat/${surah}`);
      const json = await res.json();

      /* =========================
         HEADER SURAH
      ========================= */
      const header = document.createElement('div');
      header.className = 'surah-header';
      header.innerHTML = `
        <h3>${json.data.namaLatin}</h3>
        <small>${json.data.arti}</small>
      `;
      juzContent.appendChild(header);

      /* =========================
         BISMILLAH
      ========================= */
      const isFirstSurahInJuz = surah === start[0];
      const isStartFromAyat1 = start[1] === 1;

      if (
        json.data.nomor !== 1 &&
        json.data.nomor !== 9 &&
        (!isFirstSurahInJuz || isStartFromAyat1)
      ) {
        const bismillah = document.createElement('div');
        bismillah.className = 'bismillah ayat-arab';
        bismillah.innerHTML =
          json.data.bismillah?.teksArab ||
          'Ø¨ÙØ³Ù’Ù…Ù Ø§Ù„Ù„Ù‘ÙÙ‡Ù Ø§Ù„Ø±Ù‘ÙØ­Ù’Ù…ÙÙ°Ù†Ù Ø§Ù„Ø±Ù‘ÙØ­ÙÙŠÙ…Ù';
        juzContent.appendChild(bismillah);
      }

      /* =========================
         AYAT (MUSHAF VIEW)
      ========================= */
      json.data.ayat.forEach(a => {
        const ayatNo = a.nomorAyat;

        const isStartSurah = surah === start[0];
        const isEndSurah   = surah === end[0];

        if (
          (isStartSurah && ayatNo < start[1]) ||
          (isEndSurah && ayatNo > end[1])
        ) return;

        const div = document.createElement('div');
        div.className = 'ayat-item';
        div.dataset.surah = surah;
        div.dataset.surahName = json.data.namaLatin;
        div.dataset.ayat = ayatNo;
        div.dataset.juz = juzNo;
        div.dataset.text = a.teksArab;
        div.dataset.audio = a.audio?.primary || '';

        div.innerHTML = `
          <div class="ayat-content">
            <span class="ayat-nomor">${json.data.namaLatin} : ${ayatNo}</span>
            <div class="ayat-arab">${tajwidColor(a.teksArab)}</div>
            <div class="ayat-indo">${a.teksIndonesia}</div>
          </div>

          <div class="ayat-actions">
            <button class="audio-btn" title="Putar murrotal">ğŸ”Š</button>
            <button class="bookmark-btn" title="Bookmark ayat">ğŸ”–</button>
          </div>
        `;

        juzContent.appendChild(div);
      });

    } catch (e) {
      console.error(e);
      juzContent.innerHTML = '<p>Gagal memuat juz</p>';
    }
  }
}

/* =========================
   AUDIO & BOOKMARK HANDLER
========================= */
const audioPlayer = document.createElement('audio');
document.body.appendChild(audioPlayer);

document.addEventListener('click', function (e) {

  /* BOOKMARK */
  if (e.target.classList.contains('bookmark-btn')) {
    const ayatEl = e.target.closest('.ayat-item');

    const bookmark = {
      mode: 'juz',
      juz: ayatEl.dataset.juz,
      surah: ayatEl.dataset.surah,
      surahName: ayatEl.dataset.surahName,
      ayat: ayatEl.dataset.ayat,
      text: ayatEl.dataset.text
    };

    let bookmarks = JSON.parse(localStorage.getItem('bookmarks')) || [];

    const sudahAda = bookmarks.some(b =>
      b.surah == bookmark.surah && b.ayat == bookmark.ayat
    );

    if (sudahAda) {
      alert('Ayat ini sudah dibookmark');
      return;
    }

    bookmarks.push(bookmark);
    localStorage.setItem('bookmarks', JSON.stringify(bookmarks));

    e.target.classList.add('active');
  }

  /* AUDIO */
  if (e.target.classList.contains('audio-btn')) {
    const ayatEl = e.target.closest('.ayat-item');
    const audioUrl = ayatEl.dataset.audio;

    if (!audioUrl) return alert('Audio tidak tersedia');

    audioPlayer.src = audioUrl;
    audioPlayer.play();

    document.querySelectorAll('.ayat-item')
      .forEach(el => el.classList.remove('ayat-playing'));

    ayatEl.classList.add('ayat-playing');
  }
});
</script>

</body>
</html>
