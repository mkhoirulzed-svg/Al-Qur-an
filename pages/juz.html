<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Juz</title>

<link rel="stylesheet" href="../style.css">
</head>

<body>

<header class="app-header">
  <button onclick="history.back()">‚Üê</button>
  <span id="judul">Juz</span>
</header>

<main class="container" id="juzContent">
  <p>Memuat juz...</p>
</main>

<script src="../data/juz-map.js"></script>
<script>
const juzNo = Number(new URLSearchParams(location.search).get('no'));
const juzContent = document.getElementById('juzContent');
const judul = document.getElementById('judul');

judul.textContent = `Juz ${juzNo}`;

const juzInfo = JUZ_MAP.find(j => j.juz === juzNo);

if (!juzInfo) {
  juzContent.innerHTML = '<p>Juz tidak valid</p>';
} else {
  loadJuz(juzInfo);
}

/* =========================
   TAJWID COLOR
========================= */
function tajwidColor(text) {
  return text
    .replace(/([ÿßŸàŸä])/g, '<span class="tajwid-mad">$1</span>')
    .replace(/([ŸÜŸÖ]Ÿí)/g, '<span class="tajwid-idgham">$1</span>')
    .replace(/([ŸÇÿ∑ÿ®ÿ¨ÿØ])/g, '<span class="tajwid-qalqalah">$1</span>');
}

async function loadJuz({ start, end }) {
  juzContent.innerHTML = '';

  for (let surah = start[0]; surah <= end[0]; surah++) {
    try {
      const res = await fetch(`https://equran.id/api/v2/surat/${surah}`);
      const json = await res.json();

      /* =========================
         HEADER SURAH
      ========================= */
      const header = document.createElement('div');
      header.className = 'surah-header';
      header.innerHTML = `
        <h3>${json.data.namaLatin}</h3>
        <small>${json.data.arti}</small>
      `;
      juzContent.appendChild(header);

      /* =========================
         BISMILLAH
      ========================= */
      const isFirstSurahInJuz = surah === start[0];
      const isStartFromAyat1 = start[1] === 1;

      if (
        json.data.nomor !== 1 &&
        json.data.nomor !== 9 &&
        (!isFirstSurahInJuz || isStartFromAyat1)
      ) {
        const bismillah = document.createElement('div');
        bismillah.className = 'bismillah ayat-arab';
        bismillah.innerHTML =
          json.data.bismillah?.teksArab ||
          'ÿ®Ÿêÿ≥ŸíŸÖŸê ÿßŸÑŸÑŸëŸéŸáŸê ÿßŸÑÿ±ŸëŸéÿ≠ŸíŸÖŸéŸ∞ŸÜŸê ÿßŸÑÿ±ŸëŸéÿ≠ŸêŸäŸÖŸê';
        juzContent.appendChild(bismillah);
      }

      /* =========================
         AYAT + BOOKMARK
      ========================= */
      json.data.ayat.forEach(a => {
        const ayatNo = a.nomorAyat;

        const isStartSurah = surah === start[0];
        const isEndSurah   = surah === end[0];

        if (
          (isStartSurah && ayatNo < start[1]) ||
          (isEndSurah && ayatNo > end[1])
        ) return;

        const div = document.createElement('div');
        div.className = 'ayat-item';
        div.dataset.surah = surah;
        div.dataset.surahName = json.data.namaLatin;
        div.dataset.ayat = ayatNo;
        div.dataset.juz = juzNo;
        div.dataset.text = a.teksArab;

        div.innerHTML = `
          <div class="ayat-header">
            <span class="ayat-nomor">${json.data.namaLatin} : ${ayatNo}</span>
            <button class="bookmark-btn" title="Bookmark ayat">üîñ</button>
          </div>

          <div class="ayat-arab">${tajwidColor(a.teksArab)}</div>
          <div class="ayat-indo">${a.teksIndonesia}</div>
        `;

        juzContent.appendChild(div);
      });

    } catch (e) {
      juzContent.innerHTML = '<p>Gagal memuat juz</p>';
    }
  }
}

/* =========================
   BOOKMARK HANDLER (JUZ)
========================= */
document.addEventListener('click', function (e) {
  if (!e.target.classList.contains('bookmark-btn')) return;

  const ayatEl = e.target.closest('.ayat-item');

  const bookmark = {
    mode: 'juz',
    juz: ayatEl.dataset.juz,
    surah: ayatEl.dataset.surah,
    surahName: ayatEl.dataset.surahName,
    ayat: ayatEl.dataset.ayat,
    text: ayatEl.dataset.text
  };

  let bookmarks = JSON.parse(localStorage.getItem('bookmarks')) || [];

  const sudahAda = bookmarks.some(b =>
    b.surah == bookmark.surah && b.ayat == bookmark.ayat
  );

  if (sudahAda) {
    alert('Ayat ini sudah dibookmark');
    return;
  }

  bookmarks.push(bookmark);
  localStorage.setItem('bookmarks', JSON.stringify(bookmarks));

  e.target.classList.add('active');
});
</script>

</body>
</html>