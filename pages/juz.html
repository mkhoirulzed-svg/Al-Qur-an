<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Juz</title>

<link rel="stylesheet" href="../style.css">
</head>

<body>

<header class="app-header">
  <button class="nav-btn back-btn" onclick="history.back()">â†</button>

  <div class="header-title">
    <span id="judul">Juz</span>
  </div>

  <button class="nav-btn translate-btn" id="toggleTerjemah">ğŸŒ</button>
</header>

<main class="container" id="juzContent">
  <p>Memuat juz...</p>
</main>

<audio id="audioPlayer"></audio>

<script src="../data/juz-map.js"></script>
<script>
const juzNo = Number(new URLSearchParams(location.search).get('no'));
const juzContent = document.getElementById('juzContent');
const judul = document.getElementById('judul');
const audioPlayer = document.getElementById('audioPlayer');
const toggleBtn = document.getElementById('toggleTerjemah');

judul.textContent = `Juz ${juzNo}`;

const juzInfo = JUZ_MAP.find(j => j.juz === juzNo);
if (!juzInfo) {
  juzContent.innerHTML = '<p>Juz tidak valid</p>';
  throw new Error('Juz tidak valid');
}

/* =========================
   BOOKMARK HELPERS
========================= */
function getBookmarks() {
  return JSON.parse(localStorage.getItem('bookmarks')) || [];
}

function isBookmarked(juz, surah, ayat) {
  return getBookmarks().some(b =>
    b.mode === 'juz' &&
    b.juz == juz &&
    b.surah == surah &&
    b.ayat == ayat
  );
}

/* =========================
   TAJWID COLOR
========================= */
function tajwidColor(text) {
  return text
    .replace(/([Ø§ÙˆÙŠ])/g, '<span class="tajwid-mad">$1</span>')
    .replace(/([Ù†Ù…]Ù’)/g, '<span class="tajwid-idgham">$1</span>')
    .replace(/([Ù‚Ø·Ø¨Ø¬Ø¯])/g, '<span class="tajwid-qalqalah">$1</span>');
}

/* =========================
   AUDIO CONTROLLER
========================= */
let currentAyat = null;
let ayatQueue = [];
let currentIndex = -1;

audioPlayer.addEventListener('ended', () => {
  if (currentAyat) {
    currentAyat.classList.remove('ayat-playing');
  }
  currentIndex++;
  playFromQueue();
});

function playFromQueue() {
  if (currentIndex >= ayatQueue.length) return;

  const ayatEl = ayatQueue[currentIndex];
  const audioUrl = ayatEl.dataset.audio;
  if (!audioUrl) {
    currentIndex++;
    playFromQueue();
    return;
  }

  if (currentAyat) {
    currentAyat.classList.remove('ayat-playing');
  }

  currentAyat = ayatEl;
  ayatEl.classList.add('ayat-playing');
  audioPlayer.src = audioUrl;
  audioPlayer.play();
}

/* =========================
   LOAD JUZ
========================= */
async function loadJuz({ start, end }) {
  juzContent.innerHTML = '';
  ayatQueue = [];
  currentIndex = -1;

  for (let surah = start[0]; surah <= end[0]; surah++) {
    const res = await fetch(
      `https://api.alquran.cloud/v1/surah/${surah}/editions/ar.alafasy,id.indonesian`
    );
    const json = await res.json();

    const arab = json.data[0];
    const indo = json.data[1];

    /* HEADER SURAH */
    const header = document.createElement('div');
    header.className = 'surah-header';
    header.innerHTML = `
      <h3>${arab.englishName}</h3>
      <small>${arab.englishNameTranslation}</small>
    `;
    juzContent.appendChild(header);

    /* BISMILLAH */
    if (arab.number !== 1 && arab.number !== 9) {
      const b = document.createElement('div');
      b.className = 'bismillah ayat-arab';
      b.textContent = 'Ø¨ÙØ³Ù’Ù…Ù Ø§Ù„Ù„Ù‘ÙÙ‡Ù Ø§Ù„Ø±Ù‘ÙØ­Ù’Ù…ÙÙ°Ù†Ù Ø§Ù„Ø±Ù‘ÙØ­ÙÙŠÙ…Ù';
      juzContent.appendChild(b);
    }

    arab.ayahs.forEach(a => {
      const ayatNo = a.numberInSurah;

      if (
        (surah === start[0] && ayatNo < start[1]) ||
        (surah === end[0] && ayatNo > end[1])
      ) return;

      const terjemah = indo.ayahs.find(x => x.numberInSurah === ayatNo);
      const bookmarked = isBookmarked(juzNo, surah, ayatNo);

      const div = document.createElement('div');
      div.className = 'ayat-item';
      div.dataset.juz = juzNo;
      div.dataset.surah = surah;
      div.dataset.ayat = ayatNo;
      div.dataset.audio = a.audio;

      div.innerHTML = `
        <div class="ayat-content">
          <span class="ayat-nomor">${arab.englishName} : ${ayatNo}</span>
          <div class="ayat-arab">${tajwidColor(a.text)}</div>
          <div class="ayat-indo">${terjemah?.text || ''}</div>
        </div>
        <div class="ayat-actions">
          <button class="audio-btn">ğŸ”Š</button>
          <button class="bookmark-btn ${bookmarked ? 'active' : ''}">ğŸ”–</button>
        </div>
      `;

      juzContent.appendChild(div);
      ayatQueue.push(div);
    });
    if (bookmarked) {
  div.classList.add('bookmarked');
}

  }
}

loadJuz(juzInfo);

/* =========================
   TOGGLE TERJEMAH
========================= */
let showTerjemah = true;
toggleBtn.addEventListener('click', () => {
  showTerjemah = !showTerjemah;
  document.body.classList.toggle('hide-translation', !showTerjemah);
  toggleBtn.classList.toggle('active', showTerjemah);
});

/* =========================
   CLICK HANDLER
========================= */
document.addEventListener('click', e => {

  /* AUDIO */
  if (e.target.classList.contains('audio-btn')) {
    const ayatEl = e.target.closest('.ayat-item');
    currentIndex = ayatQueue.indexOf(ayatEl);
    playFromQueue();
  }

  /* BOOKMARK TOGGLE */
/* BOOKMARK TOGGLE */
const bookmarkBtn = e.target.closest('.bookmark-btn');
if (bookmarkBtn) {
  const ayatEl = bookmarkBtn.closest('.ayat-item');

  const surah = ayatEl.dataset.surah;
  const ayat  = ayatEl.dataset.ayat;

  let bookmarks = getBookmarks();

  const idx = bookmarks.findIndex(b =>
    b.mode === 'juz' &&
    b.juz == juzNo &&
    b.surah == surah &&
    b.ayat == ayat
  );

  if (idx >= 0) {
    bookmarks.splice(idx, 1);
    bookmarkBtn.classList.remove('active');
  } else {
    bookmarks.push({
      mode: 'juz',
      juz: juzNo,
      surah,
      ayat,
      text: ayatEl.querySelector('.ayat-arab').innerText
    });
    bookmarkBtn.classList.add('active');
  }

  localStorage.setItem('bookmarks', JSON.stringify(bookmarks));
}
});
</script>

</body>
</html>
