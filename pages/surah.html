<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Surah</title>

<link rel="stylesheet" href="../style.css">

<style>
/* =========================
   AYAT STYLE
========================= */
.ayat-item {
  display: flex;
  justify-content: space-between;
  gap: 12px;
  margin-bottom: 20px;
}

.ayat-content {
  flex: 1;
}

.ayat-arab {
  font-size: 1.6rem;
  line-height: 2.6rem;
  text-align: right;
}

.ayat-indo {
  font-size: 0.95rem;
  color: #555;
  margin-top: 6px;
  line-height: 1.6;
}

.ayat-nomor {
  color: #888;
  font-size: 0.85rem;
}

.ayat-actions {
  display: flex;
  flex-direction: column;
  gap: 6px;
}

.audio-btn,
.bookmark-btn {
  cursor: pointer;
  font-size: 1rem;
  background: none;
  border: none;
}

/* =========================
   BISMILLAH
========================= */
.bismillah {
  text-align: center;
  font-size: 1.6rem;
  margin: 16px 0;
}

/* =========================
   AUDIO PLAYING
========================= */
.ayat-playing {
  background-color: #fef9c3;
  border-right: 4px solid #f59e0b;
  padding-right: 8px;
}

/* =========================
   HIGHLIGHT
========================= */
.ayat-highlight {
  background: #e0f2fe;
}

/* =========================
   TOGGLE TERJEMAH
========================= */
.hide-translation .ayat-indo {
  display: none;
}
</style>
</head>

<body>

<header class="app-header">
  <button class="nav-btn back-btn" onclick="history.back()">‚Üê</button>

  <div class="header-title">
    <span id="judul">Surah</span>
  </div>

  <button class="nav-btn translate-btn" id="toggleTerjemah" title="Toggle Terjemah">
    üåê
  </button>
</header>


<main class="container" id="ayatList">
  <p>Memuat ayat...</p>
</main>

<audio id="audioPlayer"></audio>

<script>
const params = new URLSearchParams(window.location.search);
const no = Number(params.get('no'));

const ayatList = document.getElementById('ayatList');
const judul = document.getElementById('judul');
const audioPlayer = document.getElementById('audioPlayer');
const toggleBtn = document.getElementById('toggleTerjemah');

if (!no) {
  ayatList.innerHTML = '<p>Surah tidak valid</p>';
  throw new Error('Nomor surah tidak valid');
}

/* =========================
   FETCH API (ARAB + INDO)
========================= */
fetch(`https://api.alquran.cloud/v1/surah/${no}/editions/ar.alafasy,id.indonesian`)
  .then(res => res.json())
  .then(res => {

    const arab = res.data[0];
    const indo = res.data[1];

    judul.textContent = `${arab.englishName} (${arab.name})`;
    ayatList.innerHTML = '';

    function tajwidColor(text) {
      return text
        .replace(/([ÿßŸàŸä])/g, '<span class="tajwid-mad">$1</span>')
        .replace(/([ŸÜŸÖ]Ÿí)/g, '<span class="tajwid-idgham">$1</span>')
        .replace(/([ŸÇÿ∑ÿ®ÿ¨ÿØ])/g, '<span class="tajwid-qalqalah">$1</span>');
    }

    /* =========================
       BISMILLAH HEADER
    ========================= */
    if (arab.number !== 1 && arab.number !== 9) {
      const bismillah = document.createElement('div');
      bismillah.className = 'bismillah ayat-arab';
      bismillah.textContent = 'ÿ®Ÿêÿ≥ŸíŸÖŸê ÿßŸÑŸÑŸëŸéŸáŸê ÿßŸÑÿ±ŸëŸéÿ≠ŸíŸÖŸéŸ∞ŸÜŸê ÿßŸÑÿ±ŸëŸéÿ≠ŸêŸäŸÖŸê';
      ayatList.appendChild(bismillah);
    }

    /* =========================
       AYAT LOOP
    ========================= */
    arab.ayahs.forEach(a => {

      let ayatText = a.text;

      // Mushaf view: hilangkan bismillah dari ayat 1 (visual saja)
      if (
        a.numberInSurah === 1 &&
        arab.number !== 1 &&
        arab.number !== 9
      ) {
        ayatText = ayatText.replace(
          /^ÿ®Ÿêÿ≥ŸíŸÖŸê\s*[Ÿ±ÿß]ŸÑŸÑŸëŸéŸáŸê\s*[Ÿ±ÿß]ŸÑÿ±ŸëŸéÿ≠ŸíŸÖŸéŸ∞ŸÜŸê\s*[Ÿ±ÿß]ŸÑÿ±ŸëŸéÿ≠ŸêŸäŸÖŸê\s*/u,
          ''
        );
      }

      const terjemah = indo.ayahs.find(
        x => x.numberInSurah === a.numberInSurah
      );

      const div = document.createElement('div');
      div.className = 'ayat-item';
      div.id = `ayat-${a.numberInSurah}`;

      div.dataset.surah = arab.number;
      div.dataset.surahName = arab.englishName;
      div.dataset.ayat = a.numberInSurah;
      div.dataset.text = a.text;
      div.dataset.audio = a.audio;

      div.innerHTML = `
        <div class="ayat-content">
          <span class="ayat-nomor">(${a.numberInSurah})</span>
          <div class="ayat-arab">${tajwidColor(ayatText)}</div>
          <div class="ayat-indo">${terjemah?.text || ''}</div>
        </div>
        <div class="ayat-actions">
          <button class="audio-btn" title="Putar murrotal">üîä</button>
          <button class="bookmark-btn" title="Bookmark ayat">üîñ</button>
        </div>
      `;

      ayatList.appendChild(div);
    });

    /* =========================
       SCROLL KE BOOKMARK
    ========================= */
    const targetAyat = localStorage.getItem('scrollToAyat');
    if (targetAyat) {
      const el = document.getElementById(`ayat-${targetAyat}`);
      if (el) {
        el.scrollIntoView({ behavior: 'smooth', block: 'center' });
        el.classList.add('ayat-highlight');
        setTimeout(() => el.classList.remove('ayat-highlight'), 3000);
      }
      localStorage.removeItem('scrollToAyat');
    }
  })
  .catch(err => {
    console.error(err);
    ayatList.innerHTML = '<p>Gagal memuat ayat</p>';
  });

/* =========================
   TOGGLE TERJEMAH
========================= */
let showTerjemah = true;
toggleBtn.addEventListener('click', () => {
  showTerjemah = !showTerjemah;
  document.body.classList.toggle('hide-translation', !showTerjemah);
  toggleBtn.textContent = showTerjemah ? 'Terjemah' : 'Terjemah ‚ùå';
});

/* =========================
   BOOKMARK
========================= */
document.addEventListener('click', e => {
  if (!e.target.classList.contains('bookmark-btn')) return;

  const ayatEl = e.target.closest('.ayat-item');

  const bookmark = {
    mode: 'surah',
    surah: ayatEl.dataset.surah,
    surahName: ayatEl.dataset.surahName,
    ayat: ayatEl.dataset.ayat,
    text: ayatEl.dataset.text
  };

  const bookmarks = JSON.parse(localStorage.getItem('bookmarks')) || [];

  if (bookmarks.some(b => b.surah == bookmark.surah && b.ayat == bookmark.ayat)) {
    alert('Ayat ini sudah dibookmark');
    return;
  }

  bookmarks.push(bookmark);
  localStorage.setItem('bookmarks', JSON.stringify(bookmarks));
});

/* =========================
   AUDIO + HIGHLIGHT
========================= */
let currentPlaying = null;

document.addEventListener('click', e => {
  if (!e.target.classList.contains('audio-btn')) return;

  const ayatEl = e.target.closest('.ayat-item');
  const audioUrl = ayatEl.dataset.audio;

  if (!audioUrl) {
    alert('Audio tidak tersedia');
    return;
  }

  if (currentPlaying) {
    currentPlaying.classList.remove('ayat-playing');
  }

  ayatEl.classList.add('ayat-playing');
  currentPlaying = ayatEl;

  audioPlayer.src = audioUrl;
  audioPlayer.play();
});
</script>

</body>
</html>
