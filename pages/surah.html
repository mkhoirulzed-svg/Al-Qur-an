<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Surah</title>

<link rel="stylesheet" href="../style.css">

</head>

<body>

<header class="app-header">
  <button class="nav-btn back-btn" onclick="history.back()">  <svg viewBox="0 0 24 24" width="22" height="22"
      fill="none"
      stroke="currentColor"
      stroke-width="2.5"
      stroke-linecap="round"
      stroke-linejoin="round">
      <polyline points="15 18 9 12 15 6"></polyline>
    </svg></button>

    <div class="header-title">
    <span id="judul">Surah</span>
  </div>

  <button class="nav-btn translate-btn" id="toggleTerjemah" title="Toggle Terjemah">
    ğŸŒ
  </button>
</header>


<main class="container" id="ayatList">
  <p>Memuat ayat...</p>
</main>

<audio id="audioPlayer"></audio>

<script>
const params = new URLSearchParams(window.location.search);
const no = Number(params.get('no'));

const ayatList = document.getElementById('ayatList');
const judul = document.getElementById('judul');
const audioPlayer = document.getElementById('audioPlayer');
const toggleBtn = document.getElementById('toggleTerjemah');

if (!no) {
  ayatList.innerHTML = '<p>Surah tidak valid</p>';
  throw new Error('Nomor surah tidak valid');
}

  function getBookmarks() {
  return JSON.parse(localStorage.getItem('bookmarks')) || [];
}

function isBookmarkedSurah(surah, ayat) {
  return getBookmarks().some(b =>
    b.mode === 'surah' &&
    b.surah == surah &&
    b.ayat == ayat
  );
}

/* =========================
   FETCH API (ARAB + INDO)
========================= */
fetch(`https://api.alquran.cloud/v1/surah/${no}/editions/ar.alafasy,id.indonesian`)
  .then(res => res.json())
  .then(res => {

    const arab = res.data[0];
    const indo = res.data[1];

    judul.textContent = `${arab.englishName} (${arab.name})`;
    ayatList.innerHTML = '';

    function tajwidColor(text) {
      return text
        .replace(/([Ø§ÙˆÙŠ])/g, '<span class="tajwid-mad">$1</span>')
        .replace(/([Ù†Ù…]Ù’)/g, '<span class="tajwid-idgham">$1</span>')
        .replace(/([Ù‚Ø·Ø¨Ø¬Ø¯])/g, '<span class="tajwid-qalqalah">$1</span>');
    }

    /* =========================
       BISMILLAH HEADER
    ========================= */
    if (arab.number !== 1 && arab.number !== 9) {
      const bismillah = document.createElement('div');
      bismillah.className = 'bismillah ayat-arab';
      bismillah.innerHTML = `
    <span class="bismillah-deco">â</span>
    Ø¨ÙØ³Ù’Ù…Ù Ø§Ù„Ù„Ù‘ÙÙ‡Ù Ø§Ù„Ø±Ù‘ÙØ­Ù’Ù…ÙÙ°Ù†Ù Ø§Ù„Ø±Ù‘ÙØ­ÙÙŠÙ…Ù
    <span class="bismillah-deco">â</span>
  `;
      ayatList.appendChild(bismillah);
    }

    /* =========================
       AYAT LOOP
    ========================= */
    arab.ayahs.forEach(a => {

      let ayatText = a.text;

      // Mushaf view: hilangkan bismillah dari ayat 1 (visual saja)
      if (
        a.numberInSurah === 1 &&
        arab.number !== 1 &&
        arab.number !== 9
      ) {
        ayatText = ayatText.replace(
          /^Ø¨ÙØ³Ù’Ù…Ù\s*[Ù±Ø§]Ù„Ù„Ù‘ÙÙ‡Ù\s*[Ù±Ø§]Ù„Ø±Ù‘ÙØ­Ù’Ù…ÙÙ°Ù†Ù\s*[Ù±Ø§]Ù„Ø±Ù‘ÙØ­ÙÙŠÙ…Ù\s*/u,
          ''
        );
      }

      const terjemah = indo.ayahs.find(
        x => x.numberInSurah === a.numberInSurah
      );

      const div = document.createElement('div');
div.className = 'ayat-item';

if (isBookmarkedSurah(arab.number, a.numberInSurah)) {
  div.classList.add('bookmarked');
}

      div.id = `ayat-${a.numberInSurah}`;

      div.dataset.surah = arab.number;
      div.dataset.surahName = arab.englishName;
      div.dataset.ayat = a.numberInSurah;
      div.dataset.text = a.text;
      div.dataset.audio = a.audio;

      function toArabicNumber(num) {
  const arabicDigits = ['Ù ','Ù¡','Ù¢','Ù£','Ù¤','Ù¥','Ù¦','Ù§','Ù¨','Ù©'];
  return String(num).replace(/\d/g, d => arabicDigits[d]);
}

      div.innerHTML = `
  <div class="ayat-content">
    <div class="ayat-arab">
      ${tajwidColor(ayatText)}
   <span class="ayat-nomor-inline">ï´¾${toArabicNumber(a.numberInSurah)}ï´¿</span> </div>

    <div class="ayat-indo">
      ${terjemah?.text || ''}
    </div>

    <div class="ayat-actions bottom">
      <button class="audio-btn">â–¶</button>
      <img src="../icons/bookmark.png" class="bookmark-btn" title="Bookmark ayat" />
    </div>
  </div>
`;

      ayatList.appendChild(div);
    });

    /* =========================
       SCROLL KE BOOKMARK
    ========================= */
    const targetAyat = localStorage.getItem('scrollToAyat');
    if (targetAyat) {
      const el = document.getElementById(`ayat-${targetAyat}`);
      if (el) {
        el.scrollIntoView({ behavior: 'smooth', block: 'center' });
        el.classList.add('ayat-highlight');
        setTimeout(() => el.classList.remove('ayat-highlight'), 3000);
      }
      localStorage.removeItem('scrollToAyat');
    }
  })
  .catch(err => {
    console.error(err);
    ayatList.innerHTML = '<p>Gagal memuat ayat</p>';
  });

/* =========================
   TOGGLE TERJEMAH
========================= */
let showTerjemah = true;
toggleBtn.addEventListener('click', () => {
  showTerjemah = !showTerjemah;
  document.body.classList.toggle('hide-translation', !showTerjemah);
  toggleBtn.classList.toggle('active', showTerjemah);
});

/* =========================
   BOOKMARK
========================= */
/* =========================
   BOOKMARK TOGGLE + HIGHLIGHT
========================= */
document.addEventListener('click', e => {
  const btn = e.target.closest('.bookmark-btn');
  if (!btn) return;

  const ayatEl = btn.closest('.ayat-item');
  const surah = ayatEl.dataset.surah;
  const ayat  = ayatEl.dataset.ayat;

  let bookmarks = getBookmarks();

  const idx = bookmarks.findIndex(b =>
    b.mode === 'surah' &&
    b.surah == surah &&
    b.ayat == ayat
  );

  if (idx >= 0) {
    bookmarks.splice(idx, 1);
    ayatEl.classList.remove('bookmarked');
  } else {
    bookmarks.push({
      mode: 'surah',
      surah,
      surahName: ayatEl.dataset.surahName,
      ayat,
      text: ayatEl.dataset.text
    });
    ayatEl.classList.add('bookmarked');
  }

  localStorage.setItem('bookmarks', JSON.stringify(bookmarks));
});

/* =========================
   AUDIO + HIGHLIGHT
========================= */
let currentPlaying = null;

document.addEventListener('click', e => {
  const btn = e.target.closest('.audio-btn');
  if (!btn) return;

  const ayatEl = btn.closest('.ayat-item');
  const audioUrl = ayatEl.dataset.audio;

  if (!audioUrl) {
    alert('Audio tidak tersedia');
    return;
  }

  // PAUSE jika ayat yang sama sedang diputar
  if (currentPlaying === ayatEl && !audioPlayer.paused) {
    audioPlayer.pause();
    btn.textContent = 'â–¶';
    ayatEl.classList.remove('ayat-playing');
    return;
  }

  // Reset ayat sebelumnya
  if (currentPlaying && currentPlaying !== ayatEl) {
    const oldBtn = currentPlaying.querySelector('.audio-btn');
    if (oldBtn) oldBtn.textContent = 'â–¶';
    currentPlaying.classList.remove('ayat-playing');
  }

  // Play ayat baru
  currentPlaying = ayatEl;
  ayatEl.classList.add('ayat-playing');
  btn.textContent = 'â¸';

  audioPlayer.src = audioUrl;
  audioPlayer.play();
});


audioPlayer.addEventListener('ended', () => {
  if (!currentPlaying) return;

  const nextAyat = currentPlaying.nextElementSibling;

  // Jika ayat berikutnya ada
  if (nextAyat && nextAyat.classList.contains('ayat-item')) {
    const nextBtn = nextAyat.querySelector('.audio-btn');
    if (nextBtn) nextBtn.click();

    nextAyat.scrollIntoView({
      behavior: 'smooth',
      block: 'center'
    });
  } else {
    // Ayat terakhir
    const btn = currentPlaying.querySelector('.audio-btn');
    if (btn) btn.textContent = 'â–¶';

    currentPlaying.classList.remove('ayat-playing');
    currentPlaying = null;
  }
});


/* =========================
   KLIK
========================= */

document.addEventListener('click', e => {
  const ayat = e.target.closest('.ayat-item');
  if (!ayat) return;

  // matikan ayat lain
  document.querySelectorAll('.ayat-item.active')
    .forEach(a => a.classList.remove('active'));

  // aktifkan ayat ini
  ayat.classList.add('active');
});
</script>

</body>
</html>
